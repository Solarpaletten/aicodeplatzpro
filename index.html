<!DOCTYPE html>
<html lang="ru">
<head>
  <script>
    const VERSION = 'v0.4.0';
    document.addEventListener('DOMContentLoaded', () => {
      const sub = document.querySelector('.sub');
      if (sub && !sub.textContent.includes(VERSION)) sub.textContent += ` ‚Ä¢ ${VERSION}`;
    });
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI IT Solar ‚Äî Code Review Assistant (v2)</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'JetBrains Mono',ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:linear-gradient(135deg,#0a0e27 0%,#1a1f3a 50%,#2d1b69 100%);color:#fff;min-height:100vh;padding:20px}
    .container{max-width:1600px;margin:0 auto}
    .header{text-align:center;margin-bottom:24px;padding:18px;border-radius:14px;background:rgba(255,255,255,.08);backdrop-filter:blur(8px)}
    .header h1{font-size:32px;background:linear-gradient(45deg,#00d4aa,#007cf0);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .sub{opacity:.8;margin-top:6px}

    .input{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:18px}
    .block{border:1px solid rgba(255,255,255,.12);border-radius:14px;overflow:hidden;background:rgba(255,255,255,.05)}
    .label{background:linear-gradient(135deg,#667eea,#764ba2);padding:12px;text-align:center;font-weight:800}
    textarea{width:100%;height:300px;border:none;outline:none;background:rgba(0,0,0,.35);color:#fff;padding:16px;font-size:14px;line-height:1.55;resize:none}

    .toolbar{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:18px 0}
    .btn{background:linear-gradient(135deg,#00d4aa,#007cf0);border:none;color:#00131c;padding:12px 22px;border-radius:999px;font-weight:900;cursor:pointer}
    .btn.ghost{background:#182238;color:#dbeafe;border:1px solid #22304f}
    .tog{display:flex;align-items:center;gap:8px;background:#0f1a34;border:1px solid #22304f;border-radius:10px;padding:8px 12px;color:#cfe1ff}

    .results{display:none}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin:18px 0}
    .stat{background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:16px;text-align:center}
    .num{font-size:28px;font-weight:900}
    .green{color:#00d4aa}.orange{color:#ffa726}.red{color:#ff6b6b}.blue{color:#4dabf7}

    .risk{margin:6px auto 18px;max-width:600px;text-align:center;border-radius:999px;padding:10px 16px;font-weight:800}
    .risk.low{background:rgba(0,212,170,.2);color:#00d4aa}
    .risk.med{background:rgba(255,167,38,.2);color:#ffa726}
    .risk.high{background:rgba(255,107,107,.2);color:#ff6b6b}

    .changes{background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:18px;margin-bottom:16px}
    .changes h3{color:#00d4aa;margin-bottom:10px}
    .chg{display:flex;align-items:center;gap:10px;border-left:4px solid;padding:10px;border-radius:8px;margin:8px 0;background:rgba(255,255,255,.04)}
    .chg.added{border-left-color:#00d4aa}.chg.modified{border-left-color:#ffa726}.chg.removed{border-left-color:#ff6b6b}.chg.import{border-left-color:#4dabf7}
    .chgi{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900}
    .chgi.added{background:#00d4aa;color:#00140f}.chgi.modified{background:#ffa726;color:#231000}.chgi.removed{background:#ff6b6b;color:#320c10}.chgi.import{background:#4dabf7;color:#04121f}

    .diff{display:grid;grid-template-columns:1fr 1fr;gap:16px;border:1px solid rgba(255,255,255,.12);border-radius:14px;background:rgba(0,0,0,.2);overflow:hidden}
    .side h3{background:rgba(255,255,255,.1);padding:12px;text-align:center}
    .pane{max-height:64vh;overflow:auto}
    .line{display:flex;min-height:22px;border-bottom:1px dashed rgba(255,255,255,.06)}
    .ln{width:58px;flex-shrink:0;text-align:right;padding:2px 8px;font-size:12px;opacity:.7;background:#101a30;border-right:1px solid #22304f;border-left:3px solid transparent}
    .lc{flex:1;white-space:pre;overflow-wrap:anywhere;padding:2px 10px;font-size:13px}
    .same{background:rgba(0,212,170,.10)} .same .ln{border-left-color:#00d4aa}
    .changed{background:rgba(245,158,11,.10)} .changed .ln{border-left-color:#ffa726}
    .added{background:rgba(0,212,170,.18)} .added .ln{border-left-color:#00d4aa}
    .removed{background:rgba(255,107,107,.18)} .removed .ln{border-left-color:#ff6b6b}
    .hl{background:rgba(255,193,7,.35);border-radius:2px;padding:0 1px}

    /* folding */
    details.fold summary{list-style:none;cursor:pointer;background:#0f182c;color:#8fb7ff;border-left:3px solid #60a5fa;margin:4px 0 0;padding:6px 10px;border-radius:6px}
    details.fold[open] summary{color:#cfe1ff}
    .fold-meta{opacity:.7;margin-left:6px}

    @media (max-width: 1100px){.input,.diff{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üöÄ AI IT Solar PRO</h1>
      <div class="sub">Token-diff ‚Ä¢ Folding –∫–∞–∫ –≤ VS Code ‚Ä¢ LCS-–≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫</div>
    </div>

    <div class="input">
      <div class="block">
        <div class="label">üìÑ –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ (–±—ã–ª–æ)</div>
        <textarea id="code1" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥..."></textarea>
      </div>
      <div class="block">
        <div class="label">üîÑ –ù–æ–≤—ã–π –∫–æ–¥ (—Å—Ç–∞–ª–æ)</div>
        <textarea id="code2" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π –∫–æ–¥..."></textarea>
      </div>
    </div>

    <div class="toolbar">
      <button class="btn" id="btnAnalyze">üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è (Ctrl/‚åò+Enter)</button>
      <button class="btn ghost" id="btnSwap">‚áÑ –ü–æ–º–µ–Ω—è—Ç—å –º–µ—Å—Ç–∞–º–∏</button>
      <label class="tog"><input type="checkbox" id="optTrim" checked> –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ö–≤–æ—Å—Ç–æ–≤—ã–µ –ø—Ä–æ–±–µ–ª—ã</label>
      <label class="tog"><input type="checkbox" id="optWs"> –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–ª–∏—á–∏—è –≤ –ø—Ä–æ–±–µ–ª–∞—Ö</label>
      <label class="tog"><input type="checkbox" id="optCase"> –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä</label>
      <label class="tog"><input type="checkbox" id="optToken" checked> –£–º–Ω—ã–π token-diff</label>
    </div>

    <div class="results" id="results">
      <div class="stats" id="stats"></div>
      <div id="risk" class="risk"></div>

      <div class="changes" id="changes"></div>

      <div class="toolbar" style="margin-top:0">
        <button class="btn ghost" id="btnFoldAll">–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë</button>
        <button class="btn ghost" id="btnUnfoldAll">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë</button>
      </div>

      <div class="diff">
        <div class="side">
          <h3>–ë—ã–ª–æ</h3>
          <div class="pane" id="paneL"></div>
        </div>
        <div class="side">
          <h3>–°—Ç–∞–ª–æ</h3>
          <div class="pane" id="paneR"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ---------- helpers & options ----------
  const $ = id => document.getElementById(id);
  const opts = () => ({
    trim: $('optTrim').checked,
    ws: $('optWs').checked,
    caseInsensitive: $('optCase').checked,
    token: $('optToken').checked
  });
  function escapeHtml(t){ const d=document.createElement('div'); d.textContent=t; return d.innerHTML; }
  function normalizeLine(s,o){ let t=s; if(o.trim) t=t.replace(/\s+$/,''); if(o.ws) t=t.replace(/\s+/g,' '); if(o.caseInsensitive) t=t.toLowerCase(); return t; }

  // ---------- token diff (—É–º–Ω—ã–π –≤–Ω—É—Ç—Ä–∏—Å—Ç—Ä–æ—á–Ω—ã–π) ----------
  function tokenize(str){
    const re=/(\s+|\/\*[\s\S]*?\*\/|\/\/[^\n]*|"(?:\\.|[^"])*"|'(?:\\.|[^'])*'|`(?:\\.|[^`])*`|\b\d+(?:\.\d+)?\b|[A-Za-z_$][\w$]*|==|===|!=|!==|<=|>=|=>|&&|\|\||[{}()[\].,;:+\-*/%&|^!~<>?=])/g;
    const out=[]; let m; while((m=re.exec(str))!==null) out.push(m[0]); return out.length?out:[str];
  }
  function highlightDifferences(a,b){
    const TA=tokenize(a), TB=tokenize(b);
    const sigA=TA.filter(t=>!/^\s+$/.test(t));
    const sigB=TB.filter(t=>!/^\s+$/.test(t));
    const n=sigA.length,m=sigB.length,dp=Array.from({length:n+1},()=>Array(m+1).fill(0));
    for(let i=1;i<=n;i++)for(let j=1;j<=m;j++)dp[i][j]=sigA[i-1]===sigB[j-1]?dp[i-1][j-1]+1:Math.max(dp[i-1][j],dp[i][j-1]);
    let i=n,j=m; const keepA=Array(n).fill(false), keepB=Array(m).fill(false);
    while(i>0&&j>0){ if(sigA[i-1]===sigB[j-1]){keepA[i-1]=keepB[j-1]=true;i--;j--;} else if(dp[i-1][j]>=dp[i][j-1]) i--; else j--; }
    let ia=0, ib=0;
    const outA=TA.map(t=>/^\s+$/.test(t)?escapeHtml(t):(keepA[ia++]?escapeHtml(t):`<span class="hl">${escapeHtml(t)}</span>`)).join('');
    const outB=TB.map(t=>/^\s+$/.test(t)?escapeHtml(t):(keepB[ib++]?escapeHtml(t):`<span class="hl">${escapeHtml(t)}</span>`)).join('');
    return { text1: outA, text2: outB };
  }

  // ---------- LCS –ø–æ —Å—Ç—Ä–æ–∫–∞–º ----------
  function lcsLines(A,B,o){
    const a=A.map((t,i)=>({text:t, norm:normalizeLine(t,o), idx:i}));
    const b=B.map((t,i)=>({text:t, norm:normalizeLine(t,o), idx:i}));
    const n=a.length,m=b.length,dp=Array.from({length:n+1},()=>Array(m+1).fill(0));
    for(let i=1;i<=n;i++)for(let j=1;j<=m;j++)dp[i][j]=a[i-1].norm===b[j-1].norm?dp[i-1][j-1]+1:Math.max(dp[i-1][j],dp[i][j-1]);
    const ops=[]; let i=n,j=m;
    while(i>0&&j>0){
      if(a[i-1].norm===b[j-1].norm){ ops.push({type:'same', i:i-1, j:j-1}); i--; j--; }
      else if(dp[i-1][j]>=dp[i][j-1]){ ops.push({type:'del', i:i-1}); i--; }
      else { ops.push({type:'ins', j:j-1}); j--; }
    }
    while(i>0){ ops.push({type:'del', i:--i}); }
    while(j>0){ ops.push({type:'ins', j:--j}); }
    ops.reverse();
    // —Å–ª–∏—Ç—å del+ins –≤ chg
    const merged=[];
    for(const op of ops){
      const prev=merged[merged.length-1];
      if(prev && prev.type==='del' && op.type==='ins'){ merged[merged.length-1]={type:'chg', i:prev.i, j:op.j}; }
      else merged.push(op);
    }
    return { ops: merged, A:a, B:b };
  }

  // ---------- —Å–µ–º–∞–Ω—Ç–∏–∫–∞ ----------
  function isFunctionLike(line){
    const s=line.trim();
    return (
      /\bfunction\b\s+\w+\s*\(/.test(s) ||          // function name(
      /^\s*\w+\s*\([^)]*\)\s*\{\s*$/.test(s) ||     // name(args) {
      /\bclass\b\s+\w+/.test(s) ||                  // class Name
      /\bdef\b\s+\w+\s*\(/.test(s) ||               // def name(
      /=>\s*\{/.test(s)                             // arrow with body {
    );
  }
  function getFunctionDescription(oldLine,newLine){
    const name=(str)=> (str.match(/\bfunction\s+(\w+)/)?.[1]) || (str.match(/\bclass\s+(\w+)/)?.[1]) || (str.match(/^\s*(\w+)\s*\(/)?.[1]) || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è';
    if(!oldLine) return `–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è/–∫–ª–∞—Å—Å: ${name(newLine)}`;
    if(!newLine) return `–£–¥–∞–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è/–∫–ª–∞—Å—Å: ${name(oldLine)}`;
    return `–ò–∑–º–µ–Ω–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è/–∫–ª–∞—Å—Å: ${name(oldLine)}`;
  }
  function getImportDescription(oldLine,newLine){
    if(!oldLine) return `–î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç: ${newLine.trim()}`;
    if(!newLine) return `–£–¥–∞–ª—ë–Ω –∏–º–ø–æ—Ä—Ç: ${oldLine.trim()}`;
    return `–ò–∑–º–µ–Ω—ë–Ω –∏–º–ø–æ—Ä—Ç: ${oldLine.trim()} ‚Üí ${newLine.trim()}`;
  }
  function getVariableDescription(oldLine,newLine){
    const name=(s)=> (s.match(/(\w+)\s*=/)||[])[1] || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è';
    if(!oldLine) return `–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è: ${name(newLine)}`;
    if(!newLine) return `–£–¥–∞–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è: ${name(oldLine)}`;
    return `–ò–∑–º–µ–Ω–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è: ${name(oldLine)}`;
  }

  // ---------- –∞–Ω–∞–ª–∏–∑ ----------
  function analyze(){
    const raw1=$('code1').value, raw2=$('code2').value;
    if(!raw1.trim() || !raw2.trim()){ alert('–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –≤ –æ–±–∞ –±–ª–æ–∫–∞'); return; }
    const o=opts();
    const L1=raw1.split('\n'), L2=raw2.split('\n');
    const {ops, A, B} = lcsLines(L1,L2,o);

    const panes={L: $('paneL'), R: $('paneR')}; panes.L.innerHTML=''; panes.R.innerHTML='';
    const stat={same:0, chg:0, add:0, del:0, total: Math.max(L1.length,L2.length)};
    const changes={functions:[],classes:[],imports:[],variables:[],other:[]};

    const addLine=(pane, cls, n, html)=>{
      const row=document.createElement('div'); row.className=`line ${cls}`;
      const ln=document.createElement('div'); ln.className='ln'; ln.textContent=(n??'');
      const lc=document.createElement('div'); lc.className='lc'; lc.innerHTML=html||'';
      row.appendChild(ln); row.appendChild(lc); pane.appendChild(row);
    };

    for(const op of ops){
      if(op.type==='same'){
        stat.same++;
        addLine(panes.L,'same',A[op.i].idx+1,escapeHtml(A[op.i].text));
        addLine(panes.R,'same',B[op.j].idx+1,escapeHtml(B[op.j].text));
      }else if(op.type==='chg'){
        stat.chg++;
        const a=A[op.i]?.text ?? '', b=B[op.j]?.text ?? '';
        const {text1,text2}=highlightDifferences(a,b);
        addLine(panes.L,'changed',(A[op.i]?.idx??null)+1,text1);
        addLine(panes.R,'changed',(B[op.j]?.idx??null)+1,text2);
        // —Å–µ–º–∞–Ω—Ç–∏–∫–∞
        collectSemantics(a,b,changes,(A[op.i]?.idx??B[op.j]?.idx??0)+1);
      }else if(op.type==='del'){
        stat.del++;
        const a=A[op.i]?.text ?? '';
        addLine(panes.L,'removed',A[op.i].idx+1,escapeHtml(a));
        addLine(panes.R,'removed',null,'');
        collectSemantics(a,'',changes,(A[op.i].idx)+1);
      }else if(op.type==='ins'){
        stat.add++;
        const b=B[op.j]?.text ?? '';
        addLine(panes.L,'added',null,'');
        addLine(panes.R,'added',B[op.j].idx+1,escapeHtml(b));
        collectSemantics('',b,changes,(B[op.j].idx)+1);
      }
    }

    // —Å–≤–æ–¥–∫–∞
    const percentSame = Math.round((stat.same/stat.total)*100);
    $('stats').innerHTML = `
      <div class="stat"><div class="num green">${stat.same}</div><div>–ù–µ–∏–∑–º–µ–Ω–Ω—ã—Ö (${percentSame}%)</div></div>
      <div class="stat"><div class="num orange">${stat.chg}</div><div>–ò–∑–º–µ–Ω–µ–Ω–æ</div></div>
      <div class="stat"><div class="num green">${stat.add}</div><div>–î–æ–±–∞–≤–ª–µ–Ω–æ</div></div>
      <div class="stat"><div class="num red">${stat.del}</div><div>–£–¥–∞–ª–µ–Ω–æ</div></div>
    `;

    // —Ä–∏—Å–∫
    const risk = calcRisk(changes, stat);
    const riskEl=$('risk');
    riskEl.className='risk ' + (risk.level==='low'?'low':risk.level==='medium'?'med':'high');
    riskEl.textContent=risk.text;

    // —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    renderChanges(changes);

    // –ø–æ–∫–∞–∑–∞—Ç—å
    $('results').style.display='block';
    syncScroll($('paneL'),$('paneR'));

    // folding
    enableFolding();
  }

  function collectSemantics(oldLine,newLine,changes,lineNum){
    const o=oldLine.trim(), n=newLine.trim();
    // imports
    if (/^(import|from|#include|using)\b/i.test(o) || /^(import|from|#include|using)\b/i.test(n)) {
      if (o!==n) changes.imports.push({type: o&&n?'modified':(o?'removed':'added'), line: lineNum, description: getImportDescription(o,n)});
    }
    // functions/classes
    if (isFunctionLike(o) || isFunctionLike(n)) {
      if (o!==n) changes.functions.push({type: o&&n?'modified':(o?'removed':'added'), line: lineNum, description: getFunctionDescription(o,n)});
    }
    // variables (–ø—Ä–æ—Å—Ç–æ–µ —ç–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ)
    if (/^\s*\w+\s*=/.test(o) || /^\s*\w+\s*=/.test(n)) {
      if (o!==n) changes.variables.push({type: o&&n?'modified':(o?'removed':'added'), line: lineNum, description: getVariableDescription(o,n)});
    }
  }

  function calcRisk(changes, stat){
    let score=0;
    score += changes.functions.length*3;
    score += changes.imports.length*2;
    score += changes.variables.length*1;
    const changePercent = ((stat.chg + stat.add + stat.del)/stat.total)*100;
    if(changePercent>50) score+=5; else if(changePercent>25) score+=2;
    if(score<=3) return {level:'low', text:'üü¢ –ù–∏–∑–∫–∏–π —Ä–∏—Å–∫: –∫–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è'};
    if(score<=8) return {level:'medium', text:'üü° –°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫: —É–º–µ—Ä–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è'};
    return {level:'high', text:'üî¥ –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫: —Å–µ—Ä—å—ë–∑–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è'};
  }

  function renderChanges(ch){
    const list=[];
    const push=(arr,cat,icon)=>arr.forEach(c=>list.push({cat,icon,type:c.type,line:c.line,desc:c.description}));
    push(ch.functions,'–§—É–Ω–∫—Ü–∏—è/–ö–ª–∞—Å—Å','F');
    push(ch.imports,'–ò–º–ø–æ—Ä—Ç','I');
    push(ch.variables,'–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è','V');

    if(!list.length){ $('changes').innerHTML='<h3>üîç –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π</h3><div style="opacity:.7">–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ</div>'; return; }

    $('changes').innerHTML = '<h3>üîç –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π</h3>' + list.map(c => `
      <div class="chg ${c.type}">
        <div class="chgi ${c.type}">${c.icon}</div>
        <div><strong>${c.cat} (—Å—Ç—Ä–æ–∫–∞ ${c.line})</strong><br/><span style="opacity:.75">${escapeHtml(c.desc)}</span></div>
      </div>`).join('');
  }

  // ---------- folding ----------
  function braceDelta(text){
    return (text.match(/\{/g)||[]).length - (text.match(/\}/g)||[]).length;
  }
  function enableFolding(){
    document.querySelectorAll('.pane').forEach(pane=>{
      const lines=[...pane.querySelectorAll('.line')];
      let i=0;
      while(i<lines.length){
        const raw = lines[i].querySelector('.lc')?.textContent || '';
        if(!isFunctionLike(raw)){ i++; continue; }
        // –∏—â–µ–º –∫–æ–Ω–µ—Ü –±–ª–æ–∫–∞ –ø–æ –±–∞–ª–∞–Ω—Å—É —Å–∫–æ–±–æ–∫
        let depth = braceDelta(raw), j=i+1;
        while(j<lines.length && depth>0){
          const t=lines[j].querySelector('.lc')?.textContent || '';
          depth += braceDelta(t); j++;
        }
        const det=document.createElement('details'); det.className='fold'; // —Å–≤–µ—Ä–Ω—É—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const sum=document.createElement('summary'); sum.textContent=raw.trim(); det.appendChild(sum);
        const box=document.createElement('div');
        for(let k=i;k<j;k++) box.appendChild(lines[k]);
        det.appendChild(box);
        pane.insertBefore(det, pane.children[i]);
        i=j;
      }
    });
  }

  // ---------- UX ----------
  function syncScroll(a,b){
    let lock=false; const s=(src,dst)=>{ if(lock) return; lock=true; dst.scrollTop=src.scrollTop; dst.scrollLeft=src.scrollLeft; lock=false; };
    a.addEventListener('scroll',()=>s(a,b)); b.addEventListener('scroll',()=>s(b,a));
  }
  $('btnAnalyze').addEventListener('click', analyze);
  $('btnSwap').addEventListener('click', ()=>{ const a=$('code1').value,b=$('code2').value; $('code1').value=b; $('code2').value=a; });
  document.addEventListener('keydown', e=>{ if((e.ctrlKey||e.metaKey)&&e.key==='Enter') analyze(); });
  $('btnFoldAll').addEventListener('click', ()=>document.querySelectorAll('details.fold').forEach(d=>d.open=false));
  $('btnUnfoldAll').addEventListener('click', ()=>document.querySelectorAll('details.fold').forEach(d=>d.open=true));
</script>
</body>
</html>
